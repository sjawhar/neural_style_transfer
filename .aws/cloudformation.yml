AWSTemplateFormatVersion: 2010-09-09

Parameters:

  Environment:
    Type: String
    AllowedValues:
      - development
      - production
      - staging
      - testing

Resources:

  Vpc:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: stacks/vpc.yml
      Parameters:
        Environment: !Ref Environment

  LoadBalancer:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: stacks/load-balancer.yml
      Parameters:
        Environment: !Ref Environment
        VpcId: !GetAtt Vpc.Outputs.VpcId
        SubnetIds: !GetAtt Vpc.Outputs.PublicSubnetIds

  ServerCluster:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: stacks/server-cluster.yml
      Parameters:
        Environment: !Ref Environment
        LoadBalancerSecurityGroupId: !GetAtt LoadBalancer.Outputs.SecurityGroupId
        VpcId: !GetAtt Vpc.Outputs.VpcId

  RedisCluster:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: stacks/redis-cluster.yml
      Parameters:
        Environment: !Ref Environment
        SubnetIds: !GetAtt Vpc.Outputs.PrivateSubnetIds
        ServerClusterSecurityGroupId: !GetAtt ServerCluster.Outputs.SecurityGroupId
        VpcId: !GetAtt Vpc.Outputs.VpcId

  ImageBucket:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: stacks/image-bucket.yml
      Parameters:
        Environment: !Ref Environment
        ServerClusterRoleArn: !GetAtt ServerCluster.Outputs.ClusterRoleArn
